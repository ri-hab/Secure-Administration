{% extends 'app_auditor/base.html'%}
{% load static %}
{%block content%}
{% block css %}
<link rel="stylesheet" href="{% static 'plugins/bootstrap/css/bootstrap.css' %}">
<link rel="stylesheet" href="{% static 'plugins/bootstrap-dialog/css/bootstrap-dialog.css' %}">
<link rel="stylesheet" href="{% static 'css/AdminLTE.min.css' %}">
<style>
   .play-dialog .modal-dialog {
        width: 58%;
    }
    .large-dialog .modal-dialog {
        width: 1100px;
        height: auto;
    }
</style>
{% endblock %}
<!-- ============================================================== -->
<!-- Bread crumb and right sidebar toggle -->
<!-- ============================================================== -->
 <div class="row page-titles">
     <div class="col-md-5 align-self-center">
       <h3 class="text-themecolor"><a href='{%url "app_auditor:rdp_connection" username=user.username%}'>RDP Connections</a></h3>
     </div>
     <div class="col-md-7 align-self-center">
         <ol class="breadcrumb">
             <li class="breadcrumb-item"><a href="javascript:void(0)">Home</a></li>
             <li class="breadcrumb-item">Real Time Monitoring</li>
             <li class="breadcrumb-item active">RDP Connections</li>
         </ol>
     </div>
     <div class="">
         <button class="right-side-toggle waves-effect waves-light btn-inverse btn btn-circle btn-sm pull-right m-l-10"><i class="ti-settings text-white"></i></button>
     </div>
 </div>
 <!-- ============================================================== -->
 <!-- End Bread crumb and right sidebar toggle -->
 <!-- ============================================================== -->
 <div class="col-lg-12"><link rel="stylesheet" href="{% static 'plugins/bootstrap/css/bootstrap.css' %}">

                      <div class="card">
                          <div class="card-body">
                              <h4 class="card-title" style="text-align:center;color:#26c6da;">RDP Connections History</h4>
                              <div class="table-responsive">
                                  <table id="sshlogslist" class="table full-color-table full-muted-table hover-table">
                                      <thead>
                                        <tr>
                                            <th>Username</th>
                                            <th>Server Name</th>
                                            <th>Server IP</th>
                                            <th>Start Time</th>
                                            <th>Is Finished</th>
                                            <th>Action</th>
                                        </tr>
                                        </thead>
                                        <tbody>
                                          {% for element in logs %}
                                              {%if element.server.credential.protocol == 'rdp'%}
                                              {%if not element.is_finished %}
                                <tr>
                                    <td>{{ element.user.username }}</td>
                                    <td>{{ element.server.name }}</td>
                                    <td>{{ element.server.ip }}</td>
                                    <td>{{ element.start_time }}</td>
                                    <td>{{ element.is_finished }}</td>
                                    <td data-editable="false" class="text-center pull-left">
                                     <a class="btn btn-xs btn-danger" onclick="killguacamole('{{element.id}}','{{element.user.username}}')">Kill</a>
                                     <a class="btn btn-xs btn-success" onclick="monitorguacamole('{{element.user.username}}','{{element.server.ip}}','{{element.start_time}}','{% url 'guacamole:guacamolemonitor' element.id %}',)">Monitor</a>
                                  </td>
                                </tr>
                                {% endif %}
                                {% endif %}
                                {% endfor %}
                                </tbody>
                                  </table>
                                  <div class="m-r-15" style="float:right;">
                                        <nav aria-label="...">
                                            <ul class="pagination">
                                                <li class="page-item disabled">
                                                    <a class="page-link" href="#" tabindex="-1">Previous</a>
                                                </li>
                                                <li class="page-item"><a class="page-link" href="#">1</a></li>
                                                <li class="page-item active">
                                                    <a class="page-link" href="#">2 <span class="sr-only">(current)</span></a>
                                                </li>
                                                <li class="page-item"><a class="page-link" href="#">3</a></li>
                                                <li class="page-item">
                                                    <a class="page-link" href="#">Next</a>
                                                </li>
                                            </ul>
                                        </nav>
                                    </div>
                              </div>
                          </div>
                      </div>
                  </div>

 {% block js %}
   <script src="{% static 'admin/js/vendor/jquery/jquery.js' %}"></script>
   <script src="{% static 'plugins/jQuery/jquery-3.3.1.min.js' %}"></script>
   <!-- <script src="{% static 'plugins/jQuery/jquery-3.4.1.slim.min.js' %}"></script> -->
   <script src="{% static 'plugins/jquery-ui/jquery-ui.min.js' %}"></script>
   <script src="{% static 'plugins/bootstrap/js/bootstrap.js' %}"></script>
   <!-- <script src="{% static 'plugins/json-view/jquery.jsonview.min.js' %}"></script> -->
   <script src="{% static 'plugins/bootstrap-dialog/js/bootstrap-dialog.js' %}"></script>
   <script src="{% static 'plugins/bootbox/bootbox.js' %}"></script>
   <script type='text/javascript'>
     function killguacamole(id,username) {
         var dialog = bootbox.confirm({
             title: "<a class='text-danger'>"+'End ' + username +" Session</a>",
             message: 'Are you sure you want to end ' + username +'Session ?',
             buttons: {
                 confirm: {
                     label: 'Kill',
                     className: 'btn-danger'
                 },
                 cancel: {
                     label: 'Cancel',
                     className: 'btn-success'
                 }
             },
             callback: function (result) {
                 if (result){
                     $.ajax({
                         type: "POST",
                         url: '{% url "guacamole:guacamolekill"%}',
                         dataType: "json",
                         data: {'id':id},
                         success: function (data) {

                             if (data['status']){
                                 toastr["success"](data['message']);
                                 setTimeout(function () {
                                     location.reload();
                                 },2000);
                             }else{
                                 toastr["error"](data['message']);
                             }

                         },
                         failure: function (errMsg) {
                             toastr["error"](errMsg);
                           },
                       });
                   }
               }
           });
       }

 function monitorguacamole(user,ip,start_time,url){
         var div_username = 'User: ' +'<span class="text-info">'+user+'' + '</span>';
         var div_ip = 'Server: ' +'<span class="text-info">' + ip + '</span>';
         var div_time = 'Start Time: ' + '<span class="text-info">'+start_time +'</span>';
         var title = div_username + div_ip + div_time;
         BootstrapDialog.show({
             size: BootstrapDialog.SIZE_WIDE,
             title: title,
             cssClass: 'large-dialog',
             type: BootstrapDialog.TYPE_DEFAULT,
             message:$('<iframe src="' + url +'" frameborder="0" scrolling="no" onload="this.height=780;this.width=1030;this.contentWindow.focus();" onmouseover="this.contentWindow.focus();"></iframe>'),
             draggable: true
         });
         return false;
     }
   </script>

   {%endblock%}


{%endblock%}
